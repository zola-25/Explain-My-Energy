@using Energy.App.Standalone.Features.AppInit.Store.OldAppInit
@using Energy.App.Standalone.Features.AppInit.Store
@using Energy.App.Standalone.Features.EnergyReadings.Electricity.Store;
@using Energy.App.Standalone.Features.EnergyReadings.Gas;
@using Microsoft.Extensions.FileSystemGlobbing.Abstractions
@inherits FluxorComponent
@inject IDispatcher Dispatcher

<MudPaper Elevation="2" Class="d-flex flex-column mx-auto justify-content-evenly mt-3">
    <MudCard>
        <MudCardHeader Class="justify-center">
            <MudText Typo="Typo.h4">Setup Status</MudText>
        </MudCardHeader>
        <MudCardContent Class="d-flex flex-column gap-3">

            @if (!AppInit.AppStarted)
            {
                <MudAlert Severity="@Severity.Info" Elevation="2" Dense="@true">App starting...</MudAlert>
                <MudProgressLinear Size="Size.Large" Color="Color.Primary" Indeterminate="true"></MudProgressLinear>
            }

            @if (AppInit.AppStarted)
            {
                @if (CanUpdateWeatherData)
                {
                    @if (WeatherDataLoading)
                    {
                        <MudAlert Severity="@Severity.Info" Elevation="2" Dense="@true">Loading weather data...</MudAlert>
                        <MudProgressLinear Size="Size.Large" Color="Color.Success" Indeterminate="true"></MudProgressLinear>
                    }
                    else
                    {
                        <MudAlert Severity="@Severity.Success" Elevation="2" Dense="@true">Weather data loaded</MudAlert>
                    }
                }
                else
                {
                    <MudAlert Severity="@Severity.Info" Elevation="2" Dense="@true">Setup your Household for local Weather Data</MudAlert>
                }

                @if (CanUpdateElectricityData)
                {
                    @if (ElectricityDataLoading)
                    {
                        <MudAlert Severity="@Severity.Info" Elevation="2" Dense="@true">Loading electricity data...</MudAlert>
                        <MudProgressLinear Size="Size.Large" Color="Color.Success" Indeterminate="true"></MudProgressLinear>
                    }
                    else
                    {
                        <MudAlert Severity="@Severity.Success" Elevation="2" Dense="@true">Electricity data loaded</MudAlert>
                    }
                }
                else
                {
                    <MudAlert Severity="@Severity.Info" Elevation="2" Dense="@true">Setup your Electricity Meter for consumption analysis</MudAlert>
                }

                @if (CanUpdateGasData)
                {
                    @if (GasDataLoading)
                    {
                        <MudAlert Severity="@Severity.Info" Elevation="2" Dense="@true">Loading gas data...</MudAlert>
                        <MudProgressLinear Size="Size.Large" Color="Color.Success" Indeterminate="true"></MudProgressLinear>
                    }
                    else
                    {
                        <MudAlert Severity="@Severity.Success" Elevation="2" Dense="@true">Gas data loaded</MudAlert>
                    }
                }
                else
                {
                    <MudAlert Severity="@Severity.Info" Elevation="2" Dense="@true">Setup your Gas Meter for consumption analysis</MudAlert>
                }

            }

        </MudCardContent>
    </MudCard>


</MudPaper>


@code {

    int _loadingProgress = 0;

    [Inject]
    private AppInit AppInit { get; set; }

    [Inject]
    private IState<AppInitState> AppInitState { get; set; }

    [Inject]
    IState<HouseholdState> HouseholdState { get; set; }

    [Inject]
    IState<WeatherState> WeatherState { get; set; }

    [Inject]
    IState<MeterSetupState> MeterSetupState { get; set; }

    [Inject]
    IState<GasReadingsState> GasReadingsState { get; set; }

    [Inject]
    IState<ElectricityReadingsState> ElectricityReadingsState { get; set; }

    [Inject]
    IState<HeatingForecastState> LinearCoefficientsState { get; set; }

    bool CanUpdateWeatherData => AppInit.HouseholdSetupValid;
    bool CanUpdateElectricityData => AppInit.ElectricityMeterSetupValid;
    bool CanUpdateGasData => AppInit.GasMeterSetupValid;


    bool WeatherDataLoading => AppInit.WeatherDataLoading;
    bool ElectricityDataLoading => AppInit.ElectricityDataLoading;
    bool GasDataLoading => AppInit.GasDataLoading;


    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
    }

    //protected override async Task OnAfterRenderAsync(bool firstRender)
    //{
    //    if (firstRender)
    //    {
    //        await Task.Delay(1000);
    //        Console.WriteLine(nameof(OnAfterRender));

    //        Dispatcher.Dispatch(new InitializeAppAction());
    //    }
    //}

    private async Task WorkItem()
    {
        Console.WriteLine(DateTime.Now);
        Console.WriteLine(AppInitState.Value);
        await Task.Yield();
        await Task.Delay(1);
        StateHasChanged();
        await Task.Delay(1);
    }


}